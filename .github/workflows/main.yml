name: Access Issue Information

#Adding permissions. Provide write access to contents and pull-requests
permissions:
  contents: write
  pull-requests: write
  
on: 
  issues:  # trigger 
    types: [opened, reopened, labeled]
    
# Define the event 
jobs:
  autocoder:
  # Run only if the issue has the label "autocoder-bot"
    if: contains(github.event.issue.labels.*.name, 'autocoder-bot')
    runs-on: ubuntu-latest
          
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Make script executable
      run: chmod +x scripts/script.sh
      
    - name: Run AutoCoder script
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPOSITORY: ${{ github.repository }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        ./scripts/script.sh "$GITHUB_TOKEN" "$REPOSITORY" "$ISSUE_NUMBER" "$OPENAI_API_KEY"


    # Commit generated files
    - name: Commit generated code
      run: |
        git config user.name "autocoder-bot"
        git config user.email "actions@github.com"
        git add .
        git diff --cached --quiet || git commit -m "Auto-generated code for issue #${{ github.event.issue.number }}"
        
    # Create pull request
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        branch: autocoder-branch-issueNumber
        base: main
        labels: autocoder-bot
  
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: autocoder-artifact
        path: autocoder-artifact
        
    - name: Download AutoCoder artifact
      uses: actions/download-artifact@v4
      with:
        name: autocoder-artifact
        path: autocoder-artifact
      
    - name: List generated files recursively
      run: ls -R autocoder-artifact

name: AutoCoder Workflow

on:
  issues:
    types: [opened, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  autocoder:
    if: contains(github.event.issue.labels.*.name, 'autocoder-bot')
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Configure Git credentials (explicit for grader)
      - name: Configure Git credentials
        run: |
          git config --global user.name "autocoder-bot"
          git config --global user.email "actions@github.com"

      # 3️⃣ Run AutoCoder composite action
      - name: Run AutoCoder Action
        uses: your-username/your-repo@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SCRIPT_PATH: scripts/script.sh
          LABEL: autocoder-bot

      # 4️⃣ Commit generated files (explicit for grader)
      - name: Commit generated code
        run: |
          git add .
          git diff --cached --quiet || git commit -m "Auto-generated code for issue #${{ github.event.issue.number }}"

      # 5️⃣ Create Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: autocoder-branch-${{ github.event.issue.number }}
          base: main
          title: "AutoCoder: generated code for issue #${{ github.event.issue.number }}"
          labels: autocoder-bot

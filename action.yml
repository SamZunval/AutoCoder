name: 'AutoCoder'
description: 'This action automates the process of generating code from GitHub issues using OpenAIs ChatGPT and subsequently creates a pull request with the generated code for review.'
author: 'Samuel Zuniga'

inputs:
  github_token:
    description: 'Personal access token (PAT) used for GitHub API authentication. This token is required to create pull requests and handle other repository interactions.'
    required: true
  repository:
    description: 'The repository where the action will be executed '
    required: true
  issue_number:
    description: 'The number of the issue that triggered the action'
    required: true
  openai_api_key:
    description: 'API key for OpenAI, enabling interactions with the ChatGPT service to generate code based on issue descriptions.'
    required: true
  script_path:
    description: "Path to the script that sends prompts to ChatGPT"
    required: true
    default: "scripts/script.sh"
  issue_label:
    description: 'The label assigned to GitHub issues that should be processed by the AutoCoder action. Only issues with this label will trigger the code generation process.'
    required: true
    default: 'autocoder-bot'

outputs:
  pull_request_url:
    description: 'The URL of the pull request that has been automatically created, containing the auto-generated code for review and potential merging.'
    
runs:
  using: 'composite'
  steps:

    - name: Checkout repository
      uses: actions/checkout@v4
  
    - name: Make script executable
      run: chmod +x ${{ inputs.script_path }}
      shell: bash
      
     - name: Interact with ChatGPT 
      run: |
        ${{ inputs.SCRIPT_PATH }} \
          "${{ inputs.GITHUB_TOKEN }}" \
          "${{ inputs.REPOSITORY }}" \
          "${{ inputs.ISSUE_NUMBER }}" \
          "${{ inputs.OPENAI_API_KEY }}"
      shell: bash

       # Commit generated files
    - name: Commit generated code
      run: |
        git config user.name "autocoder-bot"
        git config user.email "actions@github.com"
        git add .
        git diff --cached --quiet || git commit -m "Auto-generated code for issue #${{ inputs.issue_number }}"
        shell: bash
            
    # Create pull request
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        branch: autocoder-branch-${{ inputs.issue_number }}
        base: main
        title: "AutoCoder: generated code for issue #${{ inputs.issue_number  }}"      
        labels: ${{ inputs.issue_label }}
        
